<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduLink | Guardian Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="common.js"></script>
</head>
<body>
  <div class="navbar">
    <div class="navbar-left">
      <div class="logo-circle">E</div>
      <div class="nav-title">EduLink</div>
    </div>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="post-request.html">Post Tuition Request</a>
      <a href="browse-tutors.html">Search & Browse Tutors</a>
      <a href="review-applications.html">Review Applications</a>
      <a href="dashboard.html" class="nav-cta">Guardian Dashboard</a>
    </div>
  </div>

  <div class="page-container">
    <h2 class="section-title">Guardian Dashboard</h2>

    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-label">Total Tuition Requests</div>
        <div class="stat-value" id="statTotalRequests">0</div>
        <div class="stat-sub">All time</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Applications Received</div>
        <div class="stat-value" id="statTotalApps">0</div>
        <div class="stat-sub">Across all requests</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Shortlisted Tutors</div>
        <div class="stat-value" id="statShortlisted">0</div>
        <div class="stat-sub">Ready to contact</div>
      </div>
    </div>

    <section style="margin-top:32px;">
      <div class="section-title">
        <span>Recent Tuition Requests</span>
        <a href="post-request.html" class="btn-secondary">+ New Request</a>
      </div>
      <div class="card table-card">
        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Class</th>
              <th>Subjects</th>
              <th>Location</th>
              <th>Salary</th>
              <th>Posted</th>
            </tr>
          </thead>
          <tbody id="reqTableBody">
            <!-- rows -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="footer">
    © 2025 EduLink Tutoring Platform · Guardian Portal
  </div>

  <script>
    const statTotalRequests = document.getElementById("statTotalRequests");
    const statTotalApps = document.getElementById("statTotalApps");
    const statShortlisted = document.getElementById("statShortlisted");
    const reqTableBody = document.getElementById("reqTableBody");

    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric"
      });
    }

    async function loadDashboard() {
      // Load requests
      const resReq = await fetch(`${API_BASE}/requests/my`);
      const requests = await resReq.json();

      statTotalRequests.textContent = requests.length;

      reqTableBody.innerHTML = "";
      if (!requests.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" class="text-muted">No tuition requests posted yet.</td>`;
        reqTableBody.appendChild(tr);
      } else {
        requests.slice().reverse().forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.studentName}</td>
            <td>${r.studentClass}</td>
            <td>${(r.subjects || []).join(", ")}</td>
            <td>${r.location}</td>
            <td>${r.salary || "-"}</td>
            <td>${formatDate(r.postedAt)}</td>
          `;
          reqTableBody.appendChild(tr);
        });
      }

      // Load applications
      const resApp = await fetch(`${API_BASE}/applications/my`);
      const apps = await resApp.json();

      statTotalApps.textContent = apps.length;
      statShortlisted.textContent = apps.filter(a => a.status === "shortlisted").length;
    }

    window.addEventListener("load", loadDashboard);
  </script>
</body>
</html>
